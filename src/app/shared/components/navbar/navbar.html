<nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-200">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16 md:h-20">
      
      <!-- Logo -->
      <a routerLink="/" class="flex items-center gap-2.5 no-underline text-gray-800 hover:opacity-80 transition-opacity group">
        <div class="relative">
          <img src="ecom-icon.png" alt="E-Com Store Logo" class="!w-9 !h-9 !text-4xl group-hover:scale-110 transition-transform">
          <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-indigo-500 rounded-full"></div>
        </div>
        <span class="text-xl md:text-2xl font-bold tracking-tight bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">E-Com Store</span>
      </a>

      <!-- Desktop Navigation (Middle) -->
      <div class="hidden md:flex items-center gap-1 ml-8">
        <a routerLink="/shopping" routerLinkActive="!bg-blue-50 !text-blue-600 !font-semibold"
            class="px-4 py-2 rounded-lg hover:bg-gray-50 transition-all duration-200 text-gray-700">
          Shop
        </a>
      </div>

      <!-- Spacer -->
      <span class="flex-1"></span>

      <!-- Right Side Icons -->
      <div class="flex items-center gap-1 md:gap-2">

        <!-- Search -->
        <div class="relative flex items-center">
          <!-- Sliding Input -->
          <div
            class="absolute right-12 top-1/2 -translate-y-1/2 overflow-hidden transition-all duration-300 ease-in-out"
            [class.w-80]="showSearch() && !isMobile()"
            [class.w-full]="showSearch() && isMobile()"
            [class.w-0]="!showSearch()"
            [class.opacity-100]="showSearch()"
            [class.opacity-0]="!showSearch()"
          >
            <input
              type="text"
              placeholder="Search products..."
              [(ngModel)]="searchQuery"
              (keyup.enter)="performSearch()"
              class="border border-gray-300 rounded-xl px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white"
            />
          </div>

          <!-- Search Icon Button -->
          <button
            mat-icon-button
            class="!text-gray-600 hover:!text-blue-600 hover:!bg-blue-50 transition-all !rounded-xl"
            (click)="toggleSearch()"
          >
            <mat-icon>search</mat-icon>
          </button>
        </div>

        <!-- Authentication State Switch -->
        @if (isAuthenticated()) {
          <!-- Wishlist Icon -->
          <button mat-icon-button routerLink="/wishlist" class="!text-gray-600 hover:!text-red-500 hover:!bg-red-50 transition-all !rounded-xl">
            <mat-icon
              [matBadge]="totalWishlistItems()"
              matBadgeColor="warn"
              [matBadgeHidden]="totalWishlistItems() === 0">
              favorite
            </mat-icon>
          </button>

          <!-- Cart Icon -->
          <button mat-icon-button routerLink="/cart" class="!text-gray-600 hover:!text-blue-600 hover:!bg-blue-50 transition-all !rounded-xl">
            <mat-icon 
              [matBadge]="totalCartItems()" 
              matBadgeColor="warn"
              [matBadgeHidden]="totalCartItems() === 0">
              shopping_cart
            </mat-icon>
          </button>

          <!-- LOGGED IN: User Dropdown -->
          <button mat-button [matMenuTriggerFor]="userMenu" class="!flex items-center gap-2.5 !px-3 !py-2.5 !min-w-0 !rounded-xl hover:!bg-gray-50 transition-all !h-auto">
            <!-- Avatar or Initials -->
            @if (currentUser()?.profileImageUrl) {
              <img class="w-9 h-9 rounded-full border-2 border-gray-200 object-cover shadow-sm flex-shrink-0"
                  [src]="currentUser()?.profileImageUrl" (error)="handleImageError($event)" alt="Avatar">
            } @else {
              <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-sm shadow-sm flex-shrink-0">
                {{ getInitials(currentUser()?.displayName) }}
              </div>
            }
            <span class="hidden sm:block truncate max-w-[100px] font-medium text-gray-700">
              {{ currentUser()?.displayName }}
            </span>
            <mat-icon class="!text-gray-500">arrow_drop_down</mat-icon>
          </button>

          <!-- Menu Content -->
          <mat-menu #userMenu="matMenu" class="!mt-2">
            <div class="px-4 py-4 border-b border-gray-100 mb-1">
              <div class="flex items-center gap-3 mb-2">
                <!-- Avatar or Initials in Menu -->
                @if (currentUser()?.profileImageUrl) {
                  <img class="w-12 h-12 rounded-full border-2 border-gray-200 object-cover shadow-sm flex-shrink-0"
                      [src]="currentUser()?.profileImageUrl" (error)="handleImageError($event)" alt="Avatar">
                } @else {
                  <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-base shadow-sm flex-shrink-0">
                    {{ getInitials(currentUser()?.displayName) }}
                  </div>
                }
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-gray-800 truncate">{{ currentUser()?.displayName }}</p>
                  <p class="text-xs text-gray-500 truncate">{{ currentUser()?.email }}</p>
                </div>
              </div>
            </div>

            <button mat-menu-item routerLink="/account/profile" class="!py-3">
              <mat-icon class="!text-gray-600">person</mat-icon>
              <span class="ml-3">My Profile</span>
            </button>
            <button mat-menu-item routerLink="/account/orders" class="!py-3">
              <mat-icon class="!text-gray-600">shopping_bag</mat-icon>
              <span class="ml-3">My Orders</span>
            </button>
            <button mat-menu-item routerLink="/account/addresses" class="!py-3">
              <mat-icon class="!text-gray-600">location_on</mat-icon>
              <span class="ml-3">My Addresses</span>
            </button>

            @if (isAdmin()) {
              <mat-divider class="!my-2"></mat-divider>
              <button mat-menu-item routerLink="/admin/dashboard" class="!text-purple-600 !py-3 !bg-purple-50">
                <mat-icon color="primary">dashboard</mat-icon>
                <span class="ml-3 font-medium">Admin Dashboard</span>
              </button>
            }

            <mat-divider class="!my-2"></mat-divider>

            <!-- LOGOUT BUTTON -->
            <button mat-menu-item (click)="logout()" class="!text-red-600 !py-3 hover:!bg-red-50">
              <mat-icon color="warn">logout</mat-icon>
              <span class="ml-3 font-medium">Sign Out</span>
            </button>
          </mat-menu>
        } @else {
          <!-- LOGIN BUTTON -->
          <a
            mat-stroked-button
            routerLink="/account/login"
            class="!border-2 !border-gray-300 !text-gray-700 !rounded-xl !px-5 !py-2.5 hover:!border-gray-400 hover:!bg-gray-50 transition-all !font-medium"
          >
            Sign In
          </a>

          <!-- REGISTER BUTTON -->
          <a
            mat-flat-button
            routerLink="/account/register"
            class="!rounded-xl !px-5 !py-2.5 !bg-gradient-to-r !from-blue-600 !to-indigo-600 !text-white !shadow-md hover:!shadow-lg hover:!from-blue-700 hover:!to-indigo-700 transition-all !font-medium"
          >
            Register
          </a>
        }
      </div>
    </div>
  </div>
</nav>